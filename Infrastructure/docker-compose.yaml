version: "3.9"
services:
  authentication-microservice-api:
    container_name: authentication-microservice-api
    image: ${DOCKER_REGISTRY}/authentication-microservice-api:latest
    ports:
      - "5001:80"
    depends_on: 
      - authentication-microservice-database
    networks:
      - authentication-microservice-network
      - ocelot-gateway-network
    environment:
      DATABASE_HOST: ${DATABASE_HOST}
      DATABASE_PORT: ${DATABASE_PORT
      DATABASE_NAME: ${DATABASE_NAME}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
    volumes:
      - logs:/logs

  authentication-microservice-database:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: authentication-microservice-database
    ports: 
      - "1433:1433"
    networks: 
      - authentication-microservice-network
    environment:
      - ACCEPT_EULA:${ACCEPT_EULA}
      - MSSQL_SA_PASSWORD:${MSSQL_SA_PASSWORD}
  
  files-microservice-api:
    container_name: files-microservice-api
    image: ${DOCKER_REGISTRY}/files-microservice-api:latest
    ports:
      - "5002:80"
    depends_on:
      - files-microservice-database
    networks:
      - files-microservice-network
      - ocelot-gateway-network
      - rabbit-mq-network
    environment:
      DATABASE_HOST: ${DATABASE_HOST}
      DATABASE_PORT: ${DATABASE_PORT}
      DATABASE_NAME: ${DATABASE_NAME}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      RABBIT_MQ_HOSTNAME: ${RABBIT_MQ_HOSTNAME}
      RABBIT_MQ_USERNAME: ${RABBIT_MQ_USERNAME}
      RABBIT_MQ_PASSWORD: ${RABBIT_MQ_PASSWORD}
      RABBIT_MQ_VIRTUAL_HOST: ${RABBIT_MQ_VIRTUAL_HOST}
    volumes:
      - logs:/logs
        
  files-microservice-database:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: files-microservice-database
    ports:
      - "1434:1433"
    networks:
      - files-microservice-network
    environment:
      MSSQL_SA_PASSWORD: ${MSSQL_SA_PASSWORD}
      ACCEPT_EULA: ${ACCEPT_EULA} 
  
  storage-microservice-api:
    container_name: storage-microservice-api
    image: ${DOCKER_REGISTRY}/storage-microservice-api:latest
    ports:
      - "5003:80"
    environment:
      STORAGEPATH: ${STORAGEPATH}
      RABBIT_MQ_HOSTNAME: ${RABBIT_MQ_HOSTNAME}
      RABBIT_MQ_USERNAME: ${RABBIT_MQ_USERNAME}
      RABBIT_MQ_PASSWORD: ${RABBIT_MQ_PASSWORD}
      RABBIT_MQ_VIRTUAL_HOST: ${RABBIT_MQ_VIRTUAL_HOST}
    volumes:
      - storage-microservice-volume:/app/storage/files
      - logs:/logs
    networks:
      - rabbit-mq-network
  
  ocelot-api-gateway:
    container_name: ocelot-api-gateway
    image: ${DOCKER_REGISTRY}/ocelot-api-gateway:latest
    ports:
      - "5004:80"
    volumes:
      - logs:/logs
    networks: 
      - ocelot-gateway-network
  
  rabbitmq:
    image: masstransit/rabbitmq
    hostname: rabbitmq-host
    restart: always
    env_file:
      - environment/rabbit-mq/.env
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
    ports:
      - "15672:15672"
      - "5672:5672"
    networks: 
      - rabbit-mq-network

networks:
  authentication-microservice-network:
  files-microservice-network:
  rabbit-mq-network:
  ocelot-gateway-network:

volumes: 
  logs:
  storage-microservice-volume:
  